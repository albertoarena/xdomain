// XDomain - v0.5.8 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2013
!function(a,b){!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=[].slice;e="before",d="after",h="readyState",g="Invalid number or parameters. Please see API documentation.",(m=Array.prototype).indexOf||(m.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),f=function(a){var b,d,e;return d={},e=function(a){return d[a]||[]},b={listeners:function(a){return Array.prototype.slice.call(e(a))},on:function(a,b,f){d[a]=e(a),d[a].indexOf(b)>=0||(f=f===c?d[a].length:f,d[a].splice(f,0,b))},off:function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},fire:function(){var b,c,d,f,g,h;for(c=arguments[0],b=2<=arguments.length?n.call(arguments,1):[],h=e(c),f=0,g=h.length;g>f;f++)d=h[f],d.apply(a,b)}}},k=f(),l={},l[e]=function(a,b){return k.on(e,a,b)},l[d]=function(a,b){return k.on(d,a,b)},j=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},l.headers=j,i=a.XMLHttpRequest,a.XMLHttpRequest=function(){var b,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;if(z=new i,0===k.listeners(e).length&&0===k.listeners(d).length)return z;for(y=!1,v={headers:{}},w=null,r=f(),u=function(){q.status=w.status,q.statusText=w.statusText,w.headers||(w.headers={})},t=function(){q.responseType=w.type||"",q.response=w.data||null,q.responseText=w.text||w.data||"",q.responseXML=w.xml||null},m=function(){var a,b,c,d;w.status=z.status,w.statusText=z.statusText,c=j(z.getAllResponseHeaders()),d=[];for(a in c)b=c[a],w.headers[a]?d.push(void 0):d.push(w.headers[a]=b);return d},l=function(){return w.type=z.responseType,w.text=z.responseText,w.data=z.response||w.text,w.xml=z.responseXML},n=0,x=function(a){var b,c,e;return p(),b=function(){for(;a>n&&4>n;)q[h]=++n,2===n&&u(),4===n&&t(),r.fire("readystatechange",s("readystatechange")),4===n&&(r.fire("load",s("load")),r.fire("loadend",s("loadend")))},4>a?b():(c=k.listeners(d),e=function(){var a;if(!c.length)return b();if(a=c.shift(),2===a.length)return a(v,w),e();if(3===a.length)return a(v,w,e);throw g},e(),void 0)},s=function(b){var c;if(null!=a.document.createEventObject)return c=a.document.createEventObject(),c.type=b,c;try{return new Event(b)}catch(d){return{type:b}}},b=function(a){var b,c,d;b={};for(c in a)d=a[c],b[c]=d===z?q:d;return b},p=function(){var a,b,d,e,f;for(f=["timeout"],d=0,e=f.length;e>d;d++)b=f[d],z[b]&&v[b]===c&&(v[b]=z[b]);for(b in q)a=q[b],"function"==typeof a&&/^on(\w+)/.test(b)&&r.on(RegExp.$1,a)},z.onreadystatechange=function(){try{2===z[h]&&(m(),x(2))}catch(a){}4===z[h]&&(y=!1,m(),l(),x(4))},C=["abort","progress"],A=0,B=C.length;B>A;A++)o=C[A],z["on"+o]=function(a){return r.fire(o,b(a))};return q={withCredentials:!1,response:null,status:0},q.addEventListener=function(a,b){return r.on(a,b)},q.removeEventListener=r.off,q.dispatchEvent=function(){},q.open=function(a,b,c){v.method=a,v.url=b,v.async=c,x(1)},q.send=function(a){var b,c,d;v.body=a,d=function(){var a,b,c;w={headers:{}},y=!0,z.open(v.method,v.url,v.async),v.timeout&&(z.timeout=v.timeout),c=v.headers;for(a in c)b=c[a],z.setRequestHeader(a,b);z.send(v.body)},b=k.listeners(e),c=function(){var a,e;if(!b.length)return d();if(a=function(a){return"object"!=typeof a||"number"!=typeof a.status?c():(w=a,x(4),void 0)},e=b.shift(),1===e.length)return a(e(v));if(2===e.length)return e(v,a);throw g},c()},q.abort=function(){y&&z.abort(),r.fire("abort",arguments)},q.setRequestHeader=function(a,b){v.headers[a]=b},q.getResponseHeader=function(a){return w.headers[a]},q.getAllResponseHeaders=function(){return j(w.headers)},q},a.xhook=l}(a,b);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;for(j=location.protocol+"//"+location.host,C=function(b){var c;return b="xdomain ("+j+"): "+b,c=a.console=a.console||{},c.warn?c.warn(b):alert(b)},M=["postMessage","JSON"],E=0,I=M.length;I>E;E++)if(k=M[E],!a[k])return C("requires '"+k+"' and this browser does not support it"),void 0;for(d="V0",m=function(){return(Math.random()*Math.pow(2,32)).toString(16)},t=function(a){return/(https?:\/\/[^\/]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},B=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},r=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},x=function(a){return JSON.stringify(a)},l=function(a){return JSON.parse(a)},q=null,f=function(a){var b,c;null===q&&(q={},y());for(b in a)c=a[b],q[b]=c},y=function(){return r(function(a){var b,c,d,e,f,g,h,i,j,k,m,n,o;g="null"===a.origin?"*":a.origin,i=null;for(d in q){k=q[d];try{if(e=B(d),e.test(g)){i=B(k);break}}catch(p){}}if(!i)return C("blocked request from: '"+g+"'"),void 0;if(b=a.source,f=l(a.data),m=f.msg,h=t(m.url),!h||!i.test(h.path))return C("blocked request to path: '"+h.path+"' by regex: "+k),void 0;j=new XMLHttpRequest,j.open(m.method,m.url),j.onreadystatechange=function(){var a;if(4===j.readyState)return a={status:j.status,statusText:j.statusText,type:"",text:j.responseText,headers:xhook.headers(j.getAllResponseHeaders())},b.postMessage(x({id:f.id,msg:a}),g)},m.timeout&&(j.timeout=m.timeout),o=m.headers;for(c in o)n=o[c],j.setRequestHeader(c,n);return j.send(m.body||null)}),a===a.parent?C("slaves must be in an iframe"):a.parent.postMessage("XPING_"+d,"*")},A=null,g=function(a){var b,c;null===A&&(A={},z());for(b in a)c=a[b],A[b]=c},z=function(){return r(function(a){var b;return null!=(b=e.prototype.frames[a.origin])?b.recieve(a):void 0}),xhook.before(function(a,b){var c,d;return d=t(a.url),d&&A[d.origin]?(a.async===!1&&C("sync not supported"),c=new e(d.origin,A[d.origin]),c.send(a,b),void 0):b()})},e=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+m(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.waiters=[],this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.post=function(a){this.frame.contentWindow.postMessage(a,this.origin)},a.prototype.listen=function(a,b){if(this.listeners[a])throw"already listening for: "+a;this.listeners[a]=b},a.prototype.unlisten=function(a){delete this.listeners[a]},a.prototype.recieve=function(a){var b,c;return/^XPING(_(V\d+))?$/.test(a.data)?RegExp.$2!==d?(C("your master is not compatible with your slave, check your xdomain.js verison"),void 0):(this.ready=!0,void 0):(c=l(a.data),(b=this.listeners[c.id])?(this.unlisten(c.id),b(c.msg),void 0):(C("unkown message ("+c.id+")"),void 0))},a.prototype.send=function(a,b){var c=this;this.readyCheck(function(){var d;return d=m(),c.listen(d,function(a){return b(a)}),c.post(x({id:d,msg:a}))})},a.prototype.readyCheck=function(a){var b,d=this;return this.ready?a():(this.waiters.push(a),1===this.waiters.length&&(b=function(){if(!d.ready){if(d.waits++>=D.timeout/c)throw"Timeout connecting to iframe: "+d.origin;return setTimeout(b,c)}for(;d.waiters.length;)d.waiters.shift()()},b()),void 0)},a}(),D=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},D.parseUrl=t,D.origin=j,D.timeout=15e3,c=100,a.xdomain=D,N=b.getElementsByTagName("script"),F=0,J=N.length;J>F;F++)if(w=N[F],/xdomain/.test(w.src))for(O=["","data-"],G=0,K=O.length;K>G;G++){if(u=O[G],h=w.getAttribute(u+"slave")){if(h.indexOf(!0)){for(o=h.split(","),v={},i=0,H=0,L=o.length;L>H;H++)n=o[H],s=t(n),s&&(v[s.origin]=s.path,i++);i&&g(v);break}if(s=t(h),!s)return;v={},v[s.origin]=s.path,g(v);break}if(h=w.getAttribute(u+"master")){p={},p[h]=/./,f(p);break}}}(window,document);